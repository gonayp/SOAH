/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A9C23BDE-99F9-476E-ABF7-D5133546DCCC",variableType:4}
 */
var vl_b_1000 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B686B4D0-3BB3-4F09-8390-3FF41C685635",variableType:4}
 */
var vl_b_500 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"CDD65DBE-5A82-433C-A567-9E8EF4545D97",variableType:4}
 */
var vl_b_200 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"72F9490F-5524-4283-BE65-87233D0BEE19",variableType:4}
 */
var vl_b_100 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"66C7BE0E-E4E2-422A-8C3C-3E676AAEFFF1",variableType:4}
 */
var vl_b_50 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"51D3694F-39BD-43C6-A13F-3A5D6CB858B8",variableType:4}
 */
var vl_b_20 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DFC0E4DA-3999-448F-94A0-3E7D7AED98BF",variableType:4}
 */
var vl_b_10 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"DB12A6B6-5233-479C-BD32-E9FA3FB7E746",variableType:4}
 */
var vl_b_5 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"AFF62CC9-9C2E-48B6-B564-2A6F2B5BC806",variableType:8}
 */
var vl_diferencia = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"99D851EE-3F13-47BF-8902-CCF4E3AF9A5E",variableType:8}
 */
var vl_total = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"6AEA8DFA-B33D-4DE9-80C6-5BBA4E85B94F",variableType:4}
 */
var vl_m_2 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"AB790281-11CD-490D-9FFD-CAC2F100DEFB",variableType:4}
 */
var vl_m_1 = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"852030DA-0FB0-4800-9DCB-82BCF7F7D171",variableType:4}
 */
var vl_m_50_c = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0C10E777-A80F-4EF0-BCE6-7532CDB9D622",variableType:4}
 */
var vl_m_25_c = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F61CCC3F-3C1B-4609-A975-AFCA35C39DA8",variableType:4}
 */
var vl_m_10_c = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8DCFBE0D-F9F3-406B-BB87-470766DDC1AE",variableType:4}
 */
var vl_m_5_c = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"4F88503C-2978-48F2-92C9-7F1BF23AE87E",variableType:8}
 */
var vl_b_1000_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"201818B4-5D3A-4897-95C3-D52205E97C9E",variableType:8}
 */
var vl_b_500_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"A2E2F41D-28E4-44B5-8921-F04FC6E114D9",variableType:8}
 */
var vl_b_200_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"987062AF-5E5F-4508-99A6-2BBEA2664922",variableType:8}
 */
var vl_b_100_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"CAB88836-7482-49AB-A941-ED70FB84AB24",variableType:8}
 */
var vl_b_50_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"CE1F3745-F9AA-413B-ABFB-CF9FAE0C4438",variableType:8}
 */
var vl_b_20_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"034BD55B-8ABF-4B20-897E-FFD9763BA8CB",variableType:8}
 */
var vl_b_10_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"46984BAA-D7C2-4B6D-BF8D-C26621F42A52",variableType:8}
 */
var vl_b_5_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"22B68868-977B-4DC7-909C-9CCDECC0D550",variableType:8}
 */
var vl_m_2_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0863B4EA-4FCA-48B7-B48E-FCB94DADBF85",variableType:8}
 */
var vl_m_1_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"FD538F58-D909-4FE2-9A21-D489B692B7A9",variableType:8}
 */
var vl_m_50_c_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C1E7FCAD-B60B-4CAD-8C1F-4860DD23F87F",variableType:8}
 */
var vl_m_25_c_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"EAA624D0-2809-43B2-83CD-FD2ABD269362",variableType:8}
 */
var vl_m_10_c_t = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C36F6E55-EC80-412D-AD99-A4D95E792AC9",variableType:8}
 */
var vl_m_5_c_t = 0;

/**
 * Callback method for when form is shown.
 *
 * @param {Boolean} firstShow form is shown first time after load
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"5B9C7180-C36C-45F4-AC9C-0D65F7D24154"}
 */
function onShow(firstShow, event) {
	foundset.caja_fecha_cierre = application.getServerTimeStamp()
	
	controller.focusFirstField()
	
	inicializar()
}

/**
 * @properties={typeid:24,uuid:"96135892-C72B-442E-854D-5C7567DA68F6"}
 */
function onActionVolver() {
	databaseManager.revertEditedRecords()
	application.getWindow('Dialog').hide()
}

/**
 * @properties={typeid:24,uuid:"570C75DC-2C93-4101-BDFF-1BEDAFE6EF73"}
 */
function onActioGrabar() {
	
	if(vl_diferencia > 100 || vl_diferencia < -100){
		plugins.webnotificationsToastr.warning("La diferencia de efectivo es muy grande.","",globals.vg_toast_options)
		return
	}
	
	
	var PressedButton = plugins.dialogs.showQuestionDialog('GPP', 'Â¿Seguro que quieres cerrar la caja  ' + foundset.caja_numero + '?', 'Si', 'No')
	if (PressedButton == 'Si') { 
		
		marcarMovimientos()
		
		guardarRecuento()
	
		foundset.caja_estado = 2
		
		databaseManager.saveData()
		
		application.getWindow('Dialog').hide()
		
		application.showForm(forms.caja_historicos)
	
	}
	
}

/**
 * @properties={typeid:24,uuid:"FC682525-02CD-4456-ABBD-F5776A146475"}
 */
function guardarRecuento(){
	
	/** @type {JSFoundSet<db:/gpp/caja_recuento>} */
	var fs_caja_recuento = databaseManager.getFoundSet('gpp', 'caja_recuento')
	
	fs_caja_recuento.newRecord()
	fs_caja_recuento.company_id				= scopes.usuario.vg_company_id
	fs_caja_recuento.caja_id				= foundset.caja_id
	fs_caja_recuento.recuento_b_1000		= vl_b_1000
	fs_caja_recuento.recuento_b_100			= vl_b_100
	fs_caja_recuento.recuento_b_10			= vl_b_10
	fs_caja_recuento.recuento_b_200			= vl_b_200
	fs_caja_recuento.recuento_b_20			= vl_b_20
	fs_caja_recuento.recuento_b_500			= vl_b_500
	fs_caja_recuento.recuento_b_50			= vl_b_50
	fs_caja_recuento.recuento_b_5			= vl_b_5
	fs_caja_recuento.recuento_m_10_c		= vl_m_10_c
	fs_caja_recuento.recuento_m_1			= vl_m_1
	fs_caja_recuento.recuento_m_25_c		= vl_m_25_c
	fs_caja_recuento.recuento_m_2			= vl_m_2
	fs_caja_recuento.recuento_m_50_c		= vl_m_50_c
	fs_caja_recuento.recuento_m_5_c			= vl_m_5_c
	
	databaseManager.saveData()
	
}


/**
 * @properties={typeid:24,uuid:"7DD8F56E-9AA8-40E4-AB84-F44B32F88C51"}
 */
function marcarMovimientos(){
	
	/** @type {JSFoundSet<db:/gpp/vent_comp_forma_pago>} */
	var fs_vent_forma_pago = databaseManager.getFoundSet('gpp', 'vent_comp_forma_pago')
	
	/** @type {JSFoundSet<db:/gpp/caja_movimiento>} */
	var fs_caja_movimiento = databaseManager.getFoundSet('gpp', 'caja_movimiento')
	
	
	var nRecordCount = 0
	nRecordCount = databaseManager.getFoundSetCount(forms.caja_abierta_movimientos.foundset);
	for (var index = 1; index <= nRecordCount; index++) {
		var myMovimiento = forms.caja_abierta_movimientos.foundset.getRecord(index);
		
		if(myMovimiento.tipo == 1){//recibo o factura
			fs_vent_forma_pago.loadRecords(myMovimiento.id)
			fs_vent_forma_pago.caja_id												= foundset.caja_id
			fs_vent_forma_pago.vent_comp_forma_pago_to_vent_comprobantes.caja_id	= foundset.caja_id 
			databaseManager.saveData()
		}
		if(myMovimiento.tipo == 3){//movimientos manuales
			fs_caja_movimiento.loadRecords(myMovimiento.id)
			fs_caja_movimiento.caja_id												= foundset.caja_id
			databaseManager.saveData()
		}
		
		
	}
	
	
}



/**
 * @properties={typeid:24,uuid:"70BF581A-17AA-4D38-A1D4-DA940F7A3E1D"}
 */
function inicializar(){
	
	vl_b_1000 = 0;
	vl_b_500 = 0;
	vl_b_200 = 0;
	vl_b_100 = 0;
	vl_b_50 = 0;
	vl_b_20 = 0;
	vl_b_10 = 0;
	vl_b_5 = 0;
	vl_diferencia = foundset.caja_importe_cierre;
	vl_total = 0;
	vl_m_2 = 0;
	vl_m_1 = 0;
	vl_m_50_c = 0;
	vl_m_25_c = 0;
	vl_m_10_c = 0;
	vl_m_5_c = 0;
	vl_b_1000_t = 0;
	vl_b_500_t = 0;
	vl_b_200_t = 0;
	vl_b_100_t = 0;
	vl_b_50_t = 0;
	vl_b_20_t = 0;
	vl_b_10_t = 0;
	vl_b_5_t = 0;
	vl_m_2_t = 0;
	vl_m_1_t = 0;
	vl_m_50_c_t = 0;
	vl_m_25_c_t = 0;
	vl_m_10_c_t = 0;
	vl_m_5_c_t = 0;
	
	
}

/**
 *
 * @properties={typeid:24,uuid:"48BC15E6-15D2-4D34-B6EB-BFF10CB5381A"}
 */
function onDataChangeCantidad() {
	vl_m_5_c_t = 0.05 * vl_m_5_c
	vl_m_10_c_t = 0.1 * vl_m_10_c
	vl_m_25_c_t = 0.25 * vl_m_25_c
	vl_m_50_c_t = 0.5 * vl_m_50_c
	vl_m_1_t = vl_m_1
	vl_m_2_t = 2 * vl_m_2
	vl_b_5_t = 5 * vl_b_5
	vl_b_10_t = 10 * vl_b_10
	vl_b_20_t = 20 * vl_b_20
	vl_b_50_t = 50 * vl_b_50
	vl_b_100_t = 100 * vl_b_100
	vl_b_200_t = 200 * vl_b_200
	vl_b_500_t = 500 * vl_b_500
	vl_b_1000_t = 1000 * vl_b_1000
	
	vl_total = vl_m_5_c_t + vl_m_10_c_t + vl_m_25_c_t + vl_m_50_c_t + vl_m_1_t + vl_m_2_t + vl_b_5_t + vl_b_10_t + vl_b_20_t +
				vl_b_50_t + vl_b_100_t + vl_b_200_t + vl_b_500_t + vl_b_1000_t
	
	vl_diferencia = foundset.caja_importe_cierre - vl_total
				
	
}
